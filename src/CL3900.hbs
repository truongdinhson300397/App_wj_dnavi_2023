{{#extend "components/layout" title="エントリー済企業 一覧"}}
    {{#content "header-scripts" mode="append"}}
        <link rel="stylesheet" href="{{path}}css/companies.css" type="text/css" media="all"/>
    {{/content}}
    {{#content "main"}}
        <div class="contents-box">
            <!--  -->
            <article id="entries" class="article-box">
                <header class="article-box-header">
                    <h2 class="article-box-header-h2">
                        <span class="article-box-header-h2-jp">エントリー済企業</span>
                        <!-- <br /><span class="article-box-header-h2-eng">LIVE SEMINAR</span> -->
                    </h2>
                </header>

                <ul class="companies-ul">
                    <!--generated by js-->
                </ul>
                <div class="companies-more-box">
                    <a href="javascript:void(0);" class="companies-more js-btn-more">more</a>
                </div>

            </article>
        </div>
    {{/content}}
    {{#content "footer-scripts" mode="append"}}
        <script>
            _headerUIHandler(null, null, true);
            var contractTermId = globalInfo("contract_term_id");
            var urlHelper = new UrlHelper();
            var global = {
                jwt: globalInfo('jwt_' + contractTermId),
                userId: globalInfo('id_' + contractTermId),
                contractTermId: contractTermId,
                registrantId: globalInfo('registrant_id'),
                baseApiUrl: rootVariables.apiUrl,
                nextPage: 2,
                isFirstLoad: true
            };
            var http = new Http(global.baseApiUrl);
            $(function () {
                fetchAppliedEntries({per_page: 10, page: 1});
                onMore();
            });

            function _emptyEntries() {
                var $empty = $('<p>エントリー済みの企業はありません。</p>');
                $('.article-box').html('');
                $('.article-box').append($empty);
            }


            function fetchAppliedEntries(query) {
                query = query || null;
                if (!global.userId || !global.jwt) {
                    _emptyEntries();
                    return null;
                }

                // format query to string
                query = urlHelper.objectToQueryString(query);
                query = query + '&contract_term_id='+ global.contractTermId;

                var url = '/students/' + global.userId + '/applied_entries';

                function fetchSuccess(res) {
                    var entries = res.data;
                    if (_.isEmpty(entries)) {
                        _emptyEntries();
                        return;
                    }

                    // update next page
                    if (!_.isEmpty(res.pagination.links.next)) {
                        global.nextPage += 1;
                    } else {
                        global.nextPage = null;
                        hideMoreBtn();
                    }

                    global.isFirstLoad = false;
                    dumpEntries(_.cloneDeep(entries));
                }

                function fetchErr() {
                    _emptyEntries();
                }

                http.fetchOne(url, query, global.jwt, fetchSuccess, fetchErr, false);
            }

            function dumpEntries(entries) {
                if (_.isEmpty(entries)) {
                    return _emptyEntries();
                }
                var $entryUl = $('#entries .companies-ul');

                _.forEach(entries, function (entry, idx) {
                    var contracts = entry.recruit_guide.company.contracts;
                    _.forEach(contracts, function (contract) {
                        if(contract.e2r_pro_id !== null) {
                            fetchCompanyUrlAsura(contract.e2r_pro_id, idx);
                        }
                    });

                    var _entry_date = moment(entry.entry_date, 'YYYY-MM-DD HH:mm:ss');
                    var _$li = $('<li class="companies-ul-li">' +
                            ' <div class="companies-entry-box">' +
                            '   <div class="companies-cmp">' + entry.recruit_guide.company.company_name + '</div>' +
                            '   <div class="companies-type">' + entry.recruit_guide.company.industry_type_main + '</div>' +
                            '   <div class="companies-entry"><span class="companies-entry-ttl">エントリー日時</span><span' +
                            '     class="companies-entry-datetime">' + _entry_date.format('YYYY.MM.DD HH:mm') + '</span></div>' +
                            ' </div>' +
                            ' <div id="url_asura-' + idx + '" class="companies-btn-box">' +
                            '   <a href="/company/detail?company_id=' + entry.recruit_guide.company.company_id + '&go_tab=recruit_guide" class="btn-small btn-blue">詳細</a>' +
                            ' </div>' +
                            '</li>');

                    $entryUl.append(_$li);
                });
                $entryUl.find('.companies-ul-li').each(function (index, li) {
                    var _$li = $(li);
                    if (index === 0) {
                        _$li.addClass('upper-row');
                    } else if (index === 1) {
                        _$li.addClass('upper-row-pc');
                    }
                });
            }

            function hideMoreBtn() {
                $('#entries .js-btn-more').hide();
            }

            function _getAsuraStudentMypage (_url, _registrant) {
                return $.ajax({
                    url: _url + _registrant,
                    type: 'GET',
                    headers: {
                        'Content-Type': 'application/json',
                        'Accept': 'application/json'
                    }
                });
            }

            function fetchCompanyUrlAsura(_e2r_pro_id, _idx) {
                var dataToAsura = {'asura_company_id': _e2r_pro_id};
                $.ajax({
                    url: apiUrlAsura + '/outside_events/get_company_info',
                    type: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Accept': 'application/json'
                    },
                    data: JSON.stringify(dataToAsura),
                    success: function (res) {
                        var domainAsura = res.response;
                        if(domainAsura !== null) {
                            $.ajax({
                                url: rootVariables.apiUrl + '/students/' + global.userId + '/is_asura_student',
                                dataType: 'json',
                                type: 'GET',
                                headers: {
                                    Authorization: 'Bearer ' + global.jwt,
                                    ContentType: 'application/json',
                                    Accept: 'application/json'
                                },
                                success: function (_res) {
                                    var registrants = _.find(_res.data, function (_reg) {
                                        return _reg.e2r_pro_id === parseInt(_e2r_pro_id);
                                    });
                                    if (!_.isUndefined(registrants)) {
                                        _getAsuraStudentMypage(domainAsura.mypageService.mypageTopUrl, registrants.registrant_id).done(function (_res) {
                                            $('#url_asura-' + _idx).append('<a href="' + _res.data +'" class="btn-small btn-green mgnt10-15">企業マイページ</a>');
                                        });
                                    }
                                },
                                error: function (jqXhr, textStatus, errorThrown) {
                                    console.log(errorThrown);
                                }
                            });
                        }
                    },
                    error: function (XMLHttpRequest, textStatus, errorThrown) {
                        console.log(XMLHttpRequest);
                    }
                });
            }

            function onMore() {
                $('#entries .js-btn-more').on('click', function (e) {
                    e.preventDefault();
                    fetchAppliedEntries({per_page: 5, page: global.nextPage});
                });
            }
        </script>
    {{/content}}
{{/extend}}
